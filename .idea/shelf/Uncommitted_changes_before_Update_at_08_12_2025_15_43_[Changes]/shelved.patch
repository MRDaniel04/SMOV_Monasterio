Index: app/src/main/java/com/nextapp/monasterio/ui/virtualvisit/screens/PlanoScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.nextapp.monasterio.ui.virtualvisit.screens\r\n\r\nimport android.app.Activity\r\nimport android.content.pm.ActivityInfo\r\nimport android.os.Handler\r\nimport android.os.Looper\r\nimport android.widget.FrameLayout\r\nimport android.widget.Toast\r\nimport androidx.compose.animation.core.*\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.border\r\nimport androidx.compose.foundation.layout.*\r\nimport androidx.compose.foundation.shape.CircleShape\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.material3.*\r\nimport androidx.compose.runtime.*\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.geometry.Offset\r\nimport androidx.compose.ui.geometry.Size\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.graphics.toArgb\r\nimport androidx.compose.ui.layout.onGloballyPositioned\r\nimport androidx.compose.ui.layout.positionInRoot\r\nimport androidx.compose.ui.platform.LocalConfiguration\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.platform.LocalDensity\r\nimport androidx.compose.ui.res.painterResource\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.viewinterop.AndroidView\r\nimport androidx.navigation.NavController\r\nimport androidx.navigation.NavHostController\r\nimport android.graphics.Matrix\r\nimport android.graphics.Path\r\nimport android.util.Log\r\nimport com.nextapp.monasterio.R\r\nimport com.nextapp.monasterio.AppRoutes\r\nimport com.nextapp.monasterio.models.*\r\nimport com.nextapp.monasterio.repository.*\r\nimport com.nextapp.monasterio.ui.virtualvisit.components.DebugPhotoView\r\nimport com.nextapp.monasterio.ui.virtualvisit.utils.isPointInPath\r\nimport com.nextapp.monasterio.ui.virtualvisit.utils.isPointInPinArea\r\nimport com.nextapp.monasterio.ui.screens.VirtualVisitRoutes\r\nimport com.nextapp.monasterio.viewModels.AjustesViewModel\r\nimport com.nextapp.monasterio.ui.virtualvisit.components.GenericTutorialOverlay\r\nimport kotlinx.coroutines.delay\r\n\r\n// Clase auxiliar para definir los pasos del tutorial\r\nprivate data class TutorialStep(\r\n    val description: String,\r\n    val focusCenter: Offset,\r\n    val focusRadius: Float = 0f,\r\n    val rectSize: Size? = null,\r\n    val alignment: Alignment = Alignment.BottomCenter\r\n)\r\n\r\n@Composable\r\nfun PlanoScreen(\r\n    viewModel: AjustesViewModel,\r\n    planoId: String,\r\n    navController: NavController,\r\n    rootNavController: NavHostController? = null\r\n) {\r\n    val context = LocalContext.current\r\n    val activity = (context as? Activity)\r\n\r\n    DisposableEffect(Unit) {\r\n        activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED\r\n        onDispose {}\r\n    }\r\n\r\n    // 1. C√ÅLCULOS DE PANTALLA (LAYOUT)\r\n    val configuration = LocalConfiguration.current\r\n    val density = LocalDensity.current\r\n\r\n    val screenCenter = remember(configuration) {\r\n        with(density) {\r\n            Offset(\r\n                x = configuration.screenWidthDp.dp.toPx() / 2,\r\n                y = configuration.screenHeightDp.dp.toPx() / 2\r\n            )\r\n        }\r\n    }\r\n\r\n    // Variables de estado para layout real\r\n    var backButtonLayout by remember { mutableStateOf<Pair<Offset, Size>?>(null) }\r\n    var zoomControlsLayout by remember { mutableStateOf<Pair<Offset, Size>?>(null) }\r\n\r\n    val scope = rememberCoroutineScope()\r\n\r\n    // --- Estados de Datos ---\r\n    var plano by remember { mutableStateOf<PlanoData?>(null) }\r\n    var figuras by remember { mutableStateOf<List<FiguraData>>(emptyList()) }\r\n    var pines by remember { mutableStateOf<List<PinData>>(emptyList()) }\r\n\r\n    var isLoading by remember { mutableStateOf(true) }\r\n    var isError by remember { mutableStateOf(false) }\r\n    var retryTrigger by remember { mutableIntStateOf(0) }\r\n\r\n    // --- Estados Visuales ---\r\n    var activePath by remember { mutableStateOf<Path?>(null) }\r\n    var activeHighlight by remember { mutableStateOf<Color?>(null) }\r\n    var isPinPressed by remember { mutableStateOf(false) }\r\n    var selectedPinId by remember { mutableStateOf<String?>(null) }\r\n\r\n    // \uD83D\uDC47 ESTADO PARA ANIMACI√ìN DE PINES (GIF)\r\n    var animatingPinId by remember { mutableStateOf<String?>(null) }\r\n\r\n    // --- LOGICA DE TUTORIAL ---\r\n    val isMainDismissed by viewModel.isMainMapDismissed.collectAsState()\r\n    val isSubDismissed by viewModel.isSubMapDismissed.collectAsState()\r\n    var showTutorialSession by remember { mutableStateOf(true) }\r\n\r\n    var currentStepIndex by remember { mutableIntStateOf(0) }\r\n\r\n    val initialZoom = 1f\r\n    val planoBackgroundColor = Color(0xFFF5F5F5)\r\n    val botonesVisibles by viewModel.botonesVisibles.collectAsState()\r\n\r\n    val infiniteTransition = rememberInfiniteTransition(label = \"BlinkTransition\")\r\n    val blinkAlpha by infiniteTransition.animateFloat(\r\n        initialValue = 0f, targetValue = 1f,\r\n        animationSpec = infiniteRepeatable(tween(1500), RepeatMode.Reverse)\r\n    )\r\n\r\n    // --- Carga inicial ---\r\n    LaunchedEffect(planoId, retryTrigger) {\r\n        isLoading = true\r\n        isError = false\r\n        showTutorialSession = true\r\n        currentStepIndex = 0\r\n        try {\r\n            plano = PlanoRepository.getPlanoById(planoId)\r\n            if (plano != null) {\r\n                Log.d(\"PlanoUniversal\", \"‚úÖ Plano cargado: ${plano!!.nombre}\")\r\n                val figuraRefs = plano!!.figuras.map { it.substringAfterLast(\"/\") }\r\n                figuras = FiguraRepository.getAllFiguras().filter { figuraRefs.contains(it.id) }\r\n                val pinRefs = plano!!.pines.map { it.substringAfterLast(\"/\") }\r\n                pines = PinRepository.getAllPins().filter { pinRefs.contains(it.id) }\r\n            } else {\r\n                Log.e(\"PlanoUniversal\", \"‚ö†\uFE0F Plano no encontrado con id=$planoId\")\r\n                isError = true\r\n            }\r\n        } catch (e: Exception) {\r\n            Log.e(\"PlanoUniversal\", \"‚ùå Error cargando plano\", e)\r\n            isError = true\r\n        } finally {\r\n            isLoading = false\r\n        }\r\n    }\r\n    // \uD83D\uDC47 TEMPORIZADOR DE ANIMACI√ìN MEJORADO \uD83D\uDC47\r\n    // Usamos 'Unit' para que SOLO se lance una vez y el bucle while controle todo\r\n    LaunchedEffect(Unit) {\r\n        while (true) {\r\n            // 1. Fase est√°tica (4 segundos)\r\n            animatingPinId = null\r\n            delay(4000)\r\n\r\n            // 2. Fase Animada (Elegir y activar)\r\n            if (pines.isNotEmpty()) {\r\n                val randomPin = pines.random()\r\n                animatingPinId = randomPin.id\r\n\r\n                // 3. Duraci√≥n del GIF (2.5 segundos)\r\n                delay(2500)\r\n\r\n                // 4. Apagar\r\n                animatingPinId = null\r\n            }\r\n        }\r\n    }\r\n\r\n    // --- UI Principal ---\r\n    Box(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .background(planoBackgroundColor)\r\n    ) {\r\n        if (isLoading) {\r\n            Box(modifier = Modifier.fillMaxSize(), contentAlignment = Alignment.Center) {\r\n                CircularProgressIndicator(color = MaterialTheme.colorScheme.primary)\r\n            }\r\n            return@Box\r\n        }\r\n\r\n        if (isError) {\r\n            ConnectionErrorView(\r\n                onRetry = { retryTrigger++ },\r\n                onBack = { if (!navController.popBackStack()) rootNavController?.popBackStack() }\r\n            )\r\n            return@Box\r\n        }\r\n\r\n        var photoViewRef by remember { mutableStateOf<DebugPhotoView?>(null) }\r\n\r\n        // 1. Capa del Mapa Interactivo\r\n        AndroidView(\r\n            modifier = Modifier.fillMaxSize(),\r\n            factory = { ctx ->\r\n                DebugPhotoView(ctx).apply {\r\n                    layoutParams = FrameLayout.LayoutParams(\r\n                        FrameLayout.LayoutParams.MATCH_PARENT,\r\n                        FrameLayout.LayoutParams.MATCH_PARENT\r\n                    )\r\n                    plano?.let { p -> setImageFromUrl(p.plano) }\r\n                    post { setScale(initialZoom, true) }\r\n                    this.pins = emptyList()\r\n                }\r\n            },\r\n            // El bloque update se llama cuando cambia animatingPinId\r\n            update = { photoView ->\r\n                photoView.staticZones = figuras.map {\r\n                    DebugPhotoView.StaticZoneData(\r\n                        createPathFromFirebase(it),\r\n                        it.colorResaltado.toUInt().toInt()\r\n                    )\r\n                }\r\n\r\n                photoView.pins = pines.map { pin ->\r\n                    val baseColorInt = android.graphics.Color.WHITE\r\n\r\n                    // \uD83D\uDC47 SELECCI√ìN DE ICONO (GIF vs EST√ÅTICO)\r\n                    val isAnimating = pin.id == animatingPinId\r\n                    val iconRes = R.drawable.pin_animado\r\n\r\n                    DebugPhotoView.PinData(\r\n                        x = pin.x,\r\n                        y = pin.y,\r\n                        iconId = iconRes, // Usamos el recurso din√°mico\r\n                        isPressed = pin.id == selectedPinId,\r\n                        isMoving = false\r\n                    )\r\n                }\r\n\r\n                photoView.blinkingAlpha = blinkAlpha\r\n                photoView.interactivePath = activePath\r\n                photoView.highlightColor = activeHighlight?.toArgb() ?: Color.Transparent.toArgb()\r\n                photoView.invalidate()\r\n\r\n                photoView.setOnPhotoTapListener { _, x, y ->\r\n                    val figura = figuras.find { isPointInPath(x, y, createPathFromFirebase(it)) }\r\n                    val pin = pines.find { isPointInPinArea(x, y, it.x, it.y, it.tapRadius) }\r\n                    when {\r\n                        figura != null -> {\r\n                            activePath = createPathFromFirebase(figura)\r\n                            activeHighlight = Color(figura.colorResaltado.toUInt().toInt())\r\n                            Handler(Looper.getMainLooper()).postDelayed({\r\n                                activeHighlight = null\r\n                                when (figura.tipoDestino) {\r\n                                    \"detalle\" -> navController.navigate(\"${VirtualVisitRoutes.DETALLE_GENERICO}/${figura.valorDestino}\")\r\n                                    \"plano\" -> {\r\n                                        val destinoId = figura.valorDestino\r\n                                        if (destinoId.isNotBlank()) navController.navigate(\"${VirtualVisitRoutes.PLANO}/$destinoId\")\r\n                                        else Toast.makeText(context, context.getString(R.string.notdefined_destinyplane), Toast.LENGTH_SHORT).show()\r\n                                    }\r\n                                    else -> Toast.makeText(context, context.getString(R.string.notdefined_destiny), Toast.LENGTH_SHORT).show()\r\n                                }\r\n                            }, 200)\r\n                        }\r\n\r\n                        pin != null -> {\r\n                            selectedPinId = pin.id\r\n                            Handler(Looper.getMainLooper()).postDelayed({\r\n                                selectedPinId = null\r\n                                when (pin.tipoDestino?.lowercase()) {\r\n                                    \"ruta\" -> if (pin.valorDestino != null) rootNavController?.navigate(\r\n                                        \"${AppRoutes.PIN_ENTRADA_MONASTERIO}/${pin.id}\"\r\n                                    )\r\n                                    \"detalle\" -> navController.navigate(AppRoutes.PIN_DETALLE + \"/${pin.id}\")\r\n                                }\r\n                            }, 200)\r\n                        }\r\n\r\n                        else -> {\r\n                            selectedPinId = null\r\n                            Toast.makeText(context, context.getString(R.string.out_interactive_area), Toast.LENGTH_SHORT).show()\r\n                        }\r\n                    }\r\n                }\r\n                photoViewRef = photoView\r\n            }\r\n        )\r\n\r\n        // 2. Controles de Zoom\r\n        Column(\r\n            modifier = Modifier\r\n                .align(Alignment.CenterEnd)\r\n                .padding(end = 16.dp, bottom = 80.dp)\r\n                .onGloballyPositioned { coordinates ->\r\n                    val position = coordinates.positionInRoot()\r\n                    val size = coordinates.size\r\n                    zoomControlsLayout = position to Size(size.width.toFloat(), size.height.toFloat())\r\n                },\r\n            verticalArrangement = Arrangement.spacedBy(12.dp)\r\n        ) {\r\n            if (botonesVisibles) {\r\n                // --- AUMENTAR ---\r\n                FloatingActionButton(\r\n                    onClick = { photoViewRef?.let { it.setScale((it.scale + 0.2f).coerceAtMost(it.maximumScale), true) } },\r\n                    containerColor = Color.Transparent,\r\n                    elevation = FloatingActionButtonDefaults.elevation(0.dp)\r\n                ) {\r\n                    Box(modifier = Modifier.size(48.dp).background(Color.White.copy(alpha = 0.7f), CircleShape).border(1.dp, Color.Black, CircleShape), contentAlignment = Alignment.Center) {\r\n                        Icon(\r\n                            painter = painterResource(id = R.drawable.aumentar_zoom),\r\n                            contentDescription = stringResource(R.string.increase),\r\n                            tint = Color.Unspecified,\r\n                            modifier = Modifier.size(32.dp)\r\n                        )\r\n                    }\r\n                }\r\n\r\n                // --- DISMINUIR ---\r\n                FloatingActionButton(\r\n                    onClick = { photoViewRef?.let { it.setScale((it.scale - 0.2f).coerceAtLeast(it.minimumScale), true) } },\r\n                    containerColor = Color.Transparent,\r\n                    elevation = FloatingActionButtonDefaults.elevation(0.dp)\r\n                ) {\r\n                    Box(modifier = Modifier.size(48.dp).background(Color.White.copy(alpha = 0.7f), CircleShape).border(1.dp, Color.Black, CircleShape), contentAlignment = Alignment.Center) {\r\n                        Icon(\r\n                            painter = painterResource(id = R.drawable.disminuir_zoom),\r\n                            contentDescription = stringResource(R.string.decrease),\r\n                            tint = Color.Unspecified,\r\n                            modifier = Modifier.size(32.dp)\r\n                        )\r\n                    }\r\n                }\r\n\r\n                // --- REAJUSTAR ---\r\n                FloatingActionButton(\r\n                    onClick = { photoViewRef?.apply { setScale(initialZoom, true); setTranslationX(0f); setTranslationY(0f) } },\r\n                    containerColor = Color.Transparent,\r\n                    elevation = FloatingActionButtonDefaults.elevation(0.dp)\r\n                ) {\r\n                    Box(\r\n                        modifier = Modifier\r\n                            .size(48.dp)\r\n                            .background(Color.White.copy(alpha = 0.7f), CircleShape)\r\n                            .border(1.dp, Color.Black, CircleShape), // BORDE NEGRO\r\n                        contentAlignment = Alignment.Center\r\n                    ) {\r\n                        Icon(\r\n                            painter = painterResource(id = R.drawable.reajustar),\r\n                            contentDescription = stringResource(R.string.readjust),\r\n                            tint = Color.Unspecified,\r\n                            modifier = Modifier.size(36.dp)\r\n                        )\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        // 3. Bot√≥n Atr√°s\r\n        IconButton(\r\n            onClick = {\r\n                if (!navController.popBackStack()) {\r\n                    if (planoId == \"monasterio_exterior\") {\r\n                        rootNavController?.popBackStack()\r\n                    } else {\r\n                        navController.navigate(\"${VirtualVisitRoutes.PLANO}/monasterio_exterior\") {\r\n                            popUpTo(\"${VirtualVisitRoutes.PLANO}/monasterio_exterior\") { inclusive = false }\r\n                        }\r\n                    }\r\n                }\r\n            },\r\n            modifier = Modifier\r\n                .align(Alignment.TopStart)\r\n                .statusBarsPadding()\r\n                .padding(16.dp)\r\n                .background(Color.Black.copy(alpha = 0.5f), RoundedCornerShape(12.dp))\r\n                .onGloballyPositioned { coordinates ->\r\n                    val position = coordinates.positionInRoot()\r\n                    val size = coordinates.size\r\n                    backButtonLayout = position to Size(size.width.toFloat(), size.height.toFloat())\r\n                }\r\n        ) {\r\n            Icon(\r\n                painter = painterResource(id = R.drawable.arrow_back),\r\n                contentDescription = stringResource(R.string.go_back),\r\n                tint = Color.White\r\n            )\r\n        }\r\n\r\n        // 4. TUTORIALES\r\n        val isMainMap = (planoId == \"monasterio_exterior\")\r\n        val isLayoutReady = backButtonLayout != null && !isLoading && !isError\r\n\r\n        if (showTutorialSession && isLayoutReady) {\r\n            if (isMainMap && !isMainDismissed) {\r\n                // ... (L√≥gica tutorial mapa principal) ...\r\n                val steps = remember(backButtonLayout, zoomControlsLayout) {\r\n                    val list = mutableListOf<TutorialStep>()\r\n\r\n                    if (backButtonLayout != null) {\r\n                        val (pos, size) = backButtonLayout!!\r\n                        list.add(\r\n                            TutorialStep(\r\n                                description = context.getString(R.string.map_tutorial_body1),\r\n                                focusCenter = Offset(pos.x + size.width / 2, pos.y + size.height / 2),\r\n                                focusRadius = 100f,\r\n                                alignment = Alignment.BottomCenter\r\n                            )\r\n                        )\r\n                    }\r\n\r\n                    list.add(\r\n                        TutorialStep(\r\n                            description = context.getString(R.string.map_tutorial_body1_2),\r\n                            focusCenter = screenCenter,\r\n                            focusRadius = 250f,\r\n                            alignment = Alignment.BottomCenter\r\n                        )\r\n                    )\r\n\r\n                    if (zoomControlsLayout != null) {\r\n                        val (pos, size) = zoomControlsLayout!!\r\n                        list.add(\r\n                            TutorialStep(\r\n                                description = context.getString(R.string.map_tutorial_body1_3),\r\n                                focusCenter = Offset(pos.x + size.width / 2, pos.y + size.height / 2),\r\n                                rectSize = size,\r\n                                alignment = Alignment.TopCenter\r\n                            )\r\n                        )\r\n                    }\r\n                    list\r\n                }\r\n\r\n                if (steps.isNotEmpty() && currentStepIndex < steps.size) {\r\n                    val step = steps[currentStepIndex]\r\n                    val isLastStep = currentStepIndex == steps.size - 1\r\n                    val btnText = if (isLastStep) stringResource(R.string.understand) else stringResource(R.string.next)\r\n\r\n                    GenericTutorialOverlay(\r\n                        description = step.description,\r\n                        highlightCenter = step.focusCenter,\r\n                        highlightRadius = step.focusRadius,\r\n                        highlightRectSize = step.rectSize,\r\n                        dialogAlignment = step.alignment,\r\n                        buttonText = btnText,\r\n                        onCloseClicked = { permanent ->\r\n                            if (isLastStep) {\r\n                                showTutorialSession = false\r\n                                if (permanent) viewModel.dismissMainMap()\r\n                            } else {\r\n                                currentStepIndex++\r\n                                if (permanent) viewModel.dismissMainMap()\r\n                            }\r\n                        }\r\n                    )\r\n                }\r\n\r\n            } else if (!isMainMap && !isSubDismissed) {\r\n                // ... (L√≥gica tutorial submapa) ...\r\n                val subSteps = remember(backButtonLayout) {\r\n                    val list = mutableListOf<TutorialStep>()\r\n\r\n                    list.add(\r\n                        TutorialStep(\r\n                            description = context.getString(R.string.submapa_1),\r\n                            focusCenter = screenCenter,\r\n                            focusRadius = 300f,\r\n                            alignment = Alignment.BottomCenter\r\n                        )\r\n                    )\r\n\r\n                    if (backButtonLayout != null) {\r\n                        val (pos, size) = backButtonLayout!!\r\n                        list.add(\r\n                            TutorialStep(\r\n                                description = context.getString(R.string.submapa_2),\r\n                                focusCenter = Offset(pos.x + size.width / 2, pos.y + size.height / 2),\r\n                                focusRadius = 100f,\r\n                                alignment = Alignment.BottomCenter\r\n                            )\r\n                        )\r\n                    }\r\n                    list\r\n                }\r\n\r\n                if (subSteps.isNotEmpty() && currentStepIndex < subSteps.size) {\r\n                    val step = subSteps[currentStepIndex]\r\n                    val isLastStep = currentStepIndex == subSteps.size - 1\r\n                    val btnText = if (isLastStep) stringResource(R.string.understand) else stringResource(R.string.next)\r\n\r\n                    GenericTutorialOverlay(\r\n                        description = step.description,\r\n                        highlightCenter = step.focusCenter,\r\n                        highlightRadius = step.focusRadius,\r\n                        highlightRectSize = step.rectSize,\r\n                        buttonText = btnText,\r\n                        dialogAlignment = step.alignment,\r\n                        onCloseClicked = { permanent ->\r\n                            if (isLastStep) {\r\n                                showTutorialSession = false\r\n                                if (permanent) viewModel.dismissSubMap()\r\n                            } else {\r\n                                currentStepIndex++\r\n                                if (permanent) viewModel.dismissSubMap()\r\n                            }\r\n                        }\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// --- COMPONENTE DE ERROR DE CONEXI√ìN ---\r\n@Composable\r\nfun ConnectionErrorView(onRetry: () -> Unit, onBack: () -> Unit) {\r\n    val wifiIcons = listOf(\r\n        R.drawable.wifi_1_bar,\r\n        R.drawable.wifi_2_bar,\r\n        R.drawable.wifi\r\n    )\r\n    var currentIconIndex by remember { mutableIntStateOf(0) }\r\n\r\n    LaunchedEffect(Unit) {\r\n        while (true) {\r\n            kotlinx.coroutines.delay(500)\r\n            currentIconIndex = (currentIconIndex + 1) % wifiIcons.size\r\n        }\r\n    }\r\n\r\n    Box(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .background(Color(0xFFF5F5F5)),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        Column(\r\n            horizontalAlignment = Alignment.CenterHorizontally,\r\n            verticalArrangement = Arrangement.Center,\r\n            modifier = Modifier.padding(32.dp)\r\n        ) {\r\n            Icon(\r\n                painter = painterResource(id = wifiIcons[currentIconIndex]),\r\n                contentDescription = null,\r\n                tint = MaterialTheme.colorScheme.error,\r\n                modifier = Modifier.size(80.dp)\r\n            )\r\n            Spacer(Modifier.height(16.dp))\r\n\r\n            Text(\r\n                text = stringResource(R.string.error_connection_title),\r\n                style = MaterialTheme.typography.headlineSmall,\r\n                color = Color.Black,\r\n                fontWeight = FontWeight.Bold,\r\n                textAlign = TextAlign.Center\r\n            )\r\n            Spacer(Modifier.height(8.dp))\r\n\r\n            Text(\r\n                text = stringResource(R.string.error_connection_desc),\r\n                style = MaterialTheme.typography.bodyMedium,\r\n                color = Color.Gray,\r\n                textAlign = TextAlign.Center\r\n            )\r\n            Spacer(Modifier.height(32.dp))\r\n\r\n            Button(\r\n                onClick = onRetry,\r\n                modifier = Modifier.fillMaxWidth(0.7f),\r\n                shape = RoundedCornerShape(12.dp)\r\n            ) {\r\n                Text(stringResource(R.string.retry))\r\n            }\r\n        }\r\n\r\n        IconButton(\r\n            onClick = onBack,\r\n            modifier = Modifier\r\n                .align(Alignment.TopStart)\r\n                .statusBarsPadding()\r\n                .padding(16.dp)\r\n                .background(Color.White.copy(alpha = 0.8f), CircleShape)\r\n        ) {\r\n            Icon(\r\n                painter = painterResource(id = R.drawable.arrow_back),\r\n                contentDescription = stringResource(R.string.go_back),\r\n                tint = Color.Black\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n// --- Helper para crear Paths ---\r\nprivate fun createPathFromFirebase(figura: FiguraData): Path {\r\n    val path = Path()\r\n    if (figura.path.isEmpty()) return path\r\n    path.moveTo(figura.path[0].x, figura.path[0].y)\r\n    for (i in 1 until figura.path.size) {\r\n        path.lineTo(figura.path[i].x, figura.path[i].y)\r\n    }\r\n    path.close()\r\n    val matrix = Matrix().apply {\r\n        setScale(figura.scale, figura.scale)\r\n        postTranslate(figura.offsetX, figura.offsetY)\r\n    }\r\n    path.transform(matrix)\r\n    return path\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/nextapp/monasterio/ui/virtualvisit/screens/PlanoScreen.kt b/app/src/main/java/com/nextapp/monasterio/ui/virtualvisit/screens/PlanoScreen.kt
--- a/app/src/main/java/com/nextapp/monasterio/ui/virtualvisit/screens/PlanoScreen.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ b/app/src/main/java/com/nextapp/monasterio/ui/virtualvisit/screens/PlanoScreen.kt	(date 1765204952409)
@@ -47,6 +47,8 @@
 import com.nextapp.monasterio.viewModels.AjustesViewModel
 import com.nextapp.monasterio.ui.virtualvisit.components.GenericTutorialOverlay
 import kotlinx.coroutines.delay
+import android.media.MediaPlayer
+
 
 // Clase auxiliar para definir los pasos del tutorial
 private data class TutorialStep(
@@ -65,12 +67,24 @@
     rootNavController: NavHostController? = null
 ) {
     val context = LocalContext.current
+    val soundPines = remember {
+        MediaPlayer.create(context, R.raw.piness)
+    }
+
     val activity = (context as? Activity)
 
     DisposableEffect(Unit) {
         activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED
         onDispose {}
     }
+    val zoomPlayer = remember {
+        // Si no tienes 'zoom_sound', usa R.raw.click_button
+        MediaPlayer.create(context, R.raw.zoom)
+    }
+    val deszoomPlayer = remember {
+        // Si no tienes 'navigation_back', usa R.raw.click_button
+        MediaPlayer.create(context, R.raw.deszoom)
+    }
 
     // 1. C√ÅLCULOS DE PANTALLA (LAYOUT)
     val configuration = LocalConfiguration.current
@@ -125,6 +139,12 @@
         initialValue = 0f, targetValue = 1f,
         animationSpec = infiniteRepeatable(tween(1500), RepeatMode.Reverse)
     )
+    fun playSound(player: MediaPlayer?) {
+        if (player != null) {
+            if (player.isPlaying) player.seekTo(0)
+            player.start()
+        }
+    }
 
     // --- Carga inicial ---
     LaunchedEffect(planoId, retryTrigger) {
@@ -253,15 +273,23 @@
                                     "detalle" -> navController.navigate("${VirtualVisitRoutes.DETALLE_GENERICO}/${figura.valorDestino}")
                                     "plano" -> {
                                         val destinoId = figura.valorDestino
-                                        if (destinoId.isNotBlank()) navController.navigate("${VirtualVisitRoutes.PLANO}/$destinoId")
-                                        else Toast.makeText(context, context.getString(R.string.notdefined_destinyplane), Toast.LENGTH_SHORT).show()
-                                    }
+                                        if (destinoId.isNotBlank()) {
+                                            // üëáüëá AQU√ç SUENA AL ENTRAR AL SUBMAPA üëáüëá
+                                            playSound(zoomPlayer)
+                                            navController.navigate("${VirtualVisitRoutes.PLANO}/$destinoId")
+                                        } else {
+                                            Toast.makeText(context, context.getString(R.string.notdefined_destinyplane), Toast.LENGTH_SHORT).show()
+                                        }}
                                     else -> Toast.makeText(context, context.getString(R.string.notdefined_destiny), Toast.LENGTH_SHORT).show()
                                 }
                             }, 200)
                         }
 
                         pin != null -> {
+                            if (soundPines.isPlaying) {
+                                soundPines.seekTo(0)
+                            }
+                            soundPines.start()
                             selectedPinId = pin.id
                             Handler(Looper.getMainLooper()).postDelayed({
                                 selectedPinId = null
@@ -360,6 +388,7 @@
                     if (planoId == "monasterio_exterior") {
                         rootNavController?.popBackStack()
                     } else {
+                        playSound(deszoomPlayer)
                         navController.navigate("${VirtualVisitRoutes.PLANO}/monasterio_exterior") {
                             popUpTo("${VirtualVisitRoutes.PLANO}/monasterio_exterior") { inclusive = false }
                         }
Index: app/src/test/java/com/nextapp/monasterio/ExampleUnitTest.kt
===================================================================
diff --git a/app/src/test/java/com/nextapp/monasterio/ExampleUnitTest.kt b/app/src/test/java/com/nextapp/monasterio/ExampleUnitTest.kt
deleted file mode 100644
--- a/app/src/test/java/com/nextapp/monasterio/ExampleUnitTest.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ /dev/null	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
@@ -1,17 +0,0 @@
-package com.nextapp.monasterio
-
-import org.junit.Test
-
-import org.junit.Assert.*
-
-/**
- * Example local unit test, which will execute on the development machine (host).
- *
- * See [testing documentation](http://d.android.com/tools/testing).
- */
-class ExampleUnitTest {
-    @Test
-    fun addition_isCorrect() {
-        assertEquals(4, 2 + 2)
-    }
-}
\ No newline at end of file
Index: app/src/androidTest/java/com/nextapp/monasterio/ExampleInstrumentedTest.kt
===================================================================
diff --git a/app/src/androidTest/java/com/nextapp/monasterio/ExampleInstrumentedTest.kt b/app/src/androidTest/java/com/nextapp/monasterio/ExampleInstrumentedTest.kt
deleted file mode 100644
--- a/app/src/androidTest/java/com/nextapp/monasterio/ExampleInstrumentedTest.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ /dev/null	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
@@ -1,24 +0,0 @@
-package com.nextapp.monasterio
-
-import androidx.test.platform.app.InstrumentationRegistry
-import androidx.test.ext.junit.runners.AndroidJUnit4
-
-import org.junit.Test
-import org.junit.runner.RunWith
-
-import org.junit.Assert.*
-
-/**
- * Instrumented test, which will execute on an Android device.
- *
- * See [testing documentation](http://d.android.com/tools/testing).
- */
-@RunWith(AndroidJUnit4::class)
-class ExampleInstrumentedTest {
-    @Test
-    fun useAppContext() {
-        // Context of the app under test.
-        val appContext = InstrumentationRegistry.getInstrumentation().targetContext
-        assertEquals("com.example.smov_monasterio", appContext.packageName)
-    }
-}
\ No newline at end of file
Index: app/src/main/java/com/nextapp/monasterio/ui/screens/DiferenciasScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.nextapp.monasterio.ui.screens\r\n\r\n\r\nimport android.app.Activity\r\nimport android.content.pm.ActivityInfo\r\nimport android.util.Log\r\nimport androidx.compose.foundation.Image\r\nimport androidx.compose.foundation.layout.*\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.material3.*\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.DisposableEffect\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.setValue\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.layout.ContentScale\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.painterResource\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.lifecycle.viewmodel.compose.viewModel\r\nimport androidx.navigation.NavController\r\nimport com.nextapp.monasterio.AppRoutes\r\nimport com.nextapp.monasterio.viewModels.ImagenConToque\r\nimport com.nextapp.monasterio.viewModels.DiferenciasViewModel\r\nimport com.nextapp.monasterio.R\r\nimport com.nextapp.monasterio.repository.UserPreferencesRepository\r\n\r\n@Composable\r\nfun DiferenciasScreen(navController : NavController\r\n) {\r\n\r\n    val prefsRepository = remember { UserPreferencesRepository.instance }\r\n\r\n    val context = LocalContext.current\r\n\r\n    val viewModel: DiferenciasViewModel = viewModel(factory = DiferenciasViewModel.Companion.Factory(prefsRepository,context))\r\n\r\n    val juegoActual by viewModel.juegoActual.collectAsState()\r\n    val contador by viewModel.diferenciasEncontradas.collectAsState()\r\n\r\n    val diferenciasList = juegoActual.diferencias\r\n    val juegoTerminado = contador == diferenciasList.size\r\n\r\n    var showInstructionsPreviewDialogBoton by remember { mutableStateOf(false) }\r\n    val showInstructionsPreviewDialog by viewModel.showInstructionsDialog.collectAsState()\r\n\r\n    var mostrarPista by remember { mutableStateOf(false) }\r\n    var textoPista by remember { mutableStateOf(\"\") }\r\n    \r\n    val activity = context as? Activity\r\n\r\n    if(showInstructionsPreviewDialogBoton || showInstructionsPreviewDialog){\r\n        DiferenciasDialog(\r\n            onDismiss = {\r\n                viewModel.markInstructionsAsShown()\r\n                showInstructionsPreviewDialogBoton = false},\r\n            onConfirm = {\r\n                viewModel.markInstructionsAsShown()\r\n                showInstructionsPreviewDialogBoton = false},\r\n            titulo = stringResource(R.string.title_instructions),\r\n            texto = stringResource(R.string.text_instructions_spot_the_difference)\r\n        )\r\n    }\r\n\r\n    if(mostrarPista){\r\n        DiferenciasDialog(\r\n            onDismiss = {mostrarPista = false},\r\n            onConfirm = {mostrarPista = false},\r\n            titulo = stringResource(R.string.clue),\r\n            texto = textoPista\r\n        )\r\n    }\r\n\r\n    DisposableEffect(Unit) {\r\n        activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT\r\n        onDispose {}\r\n    }\r\n\r\n    Column(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .padding(8.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(bottom = 16.dp,top=8.dp),\r\n            horizontalArrangement = Arrangement.Center,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ) {\r\n            Text(\r\n                text = stringResource(R.string.differences_counter, contador, diferenciasList.size),\r\n                style = MaterialTheme.typography.titleSmall,\r\n                modifier = Modifier\r\n                    .padding(end = 32.dp)\r\n            )\r\n            IconButton(\r\n                onClick = { showInstructionsPreviewDialogBoton = true },\r\n                modifier = Modifier\r\n                    .size(32.dp)\r\n            ) {\r\n                Icon(\r\n                    painter = painterResource(R.drawable.question),\r\n                    contentDescription = stringResource(R.string.title_instructions),\r\n                    tint = Color.Black.copy(alpha = 0.7f),\r\n                )\r\n            }\r\n        }\r\n\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .weight(1f),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally\r\n        ) {\r\n            Image(\r\n                painter = painterResource(juegoActual.imagenOriginal),\r\n                contentDescription=\"\",\r\n                contentScale = ContentScale.Fit,\r\n                modifier = Modifier\r\n                    .fillMaxWidth()\r\n                    .weight(1f)\r\n            )\r\n\r\n            ImagenConToque(\r\n                resId = juegoActual.imagenModificada,\r\n                diferencias = diferenciasList,\r\n                onHit = viewModel::onTouch,\r\n                modifier = Modifier.weight(1f)\r\n            )\r\n            Spacer(modifier = Modifier.width(16.dp))\r\n            Button(\r\n                onClick = {\r\n                    textoPista = viewModel.mostrarPistasAleatoria()\r\n                    mostrarPista = true},\r\n            ) {\r\n                Text(stringResource(R.string.clue_button))\r\n            }\r\n        }\r\n    }\r\n\r\n    if (juegoTerminado) {\r\n        AlertDialog(\r\n            title = { Text(stringResource(R.string.congratulations)) },\r\n            text = { Text(stringResource(R.string.message_game_completed)) },\r\n            confirmButton = {\r\n                Button(onClick = {\r\n                    navController.navigate(AppRoutes.JUEGO_DIFERENCIAS) {\r\n                        popUpTo(AppRoutes.JUEGO_DIFERENCIAS) {\r\n                            inclusive = true\r\n                        }\r\n                    }\r\n                }) {\r\n                    Text(stringResource(R.string.ready))\r\n                }\r\n            },\r\n            onDismissRequest = { /* No se puede cerrar sin reiniciar */ }\r\n        )\r\n    }\r\n}\r\n\r\n@Composable\r\nfun DiferenciasDialog(\r\n    onDismiss: () -> Unit,\r\n    onConfirm : () -> Unit,\r\n    titulo: String,\r\n    texto:String\r\n){\r\n    AlertDialog(\r\n        onDismissRequest=onDismiss,\r\n        title = {\r\n            Text(titulo)\r\n        },\r\n        text = {\r\n            Text(texto)\r\n        },\r\n        confirmButton = {\r\n            Button(\r\n                onClick = onConfirm\r\n            ) {\r\n                Text(stringResource(R.string.ready))\r\n            }\r\n        },\r\n    )\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/nextapp/monasterio/ui/screens/DiferenciasScreen.kt b/app/src/main/java/com/nextapp/monasterio/ui/screens/DiferenciasScreen.kt
--- a/app/src/main/java/com/nextapp/monasterio/ui/screens/DiferenciasScreen.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ b/app/src/main/java/com/nextapp/monasterio/ui/screens/DiferenciasScreen.kt	(date 1765200524379)
@@ -10,6 +10,7 @@
 import androidx.compose.material3.*
 import androidx.compose.runtime.Composable
 import androidx.compose.runtime.DisposableEffect
+import androidx.compose.runtime.LaunchedEffect
 import androidx.compose.runtime.collectAsState
 import androidx.compose.runtime.getValue
 import androidx.compose.runtime.mutableStateOf
@@ -38,6 +39,9 @@
     val prefsRepository = remember { UserPreferencesRepository.instance }
 
     val context = LocalContext.current
+    val winSoundPlayer = remember {
+        android.media.MediaPlayer.create(context, R.raw.juego) // Aseg√∫rate de que el archivo existe
+    }
 
     val viewModel: DiferenciasViewModel = viewModel(factory = DiferenciasViewModel.Companion.Factory(prefsRepository,context))
 
@@ -79,7 +83,7 @@
 
     DisposableEffect(Unit) {
         activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT
-        onDispose {}
+        onDispose {winSoundPlayer.release()}
     }
 
     Column(
@@ -145,7 +149,14 @@
             }
         }
     }
-
+    LaunchedEffect(juegoTerminado) {
+        if (juegoTerminado) {
+            if (winSoundPlayer != null) {
+                if (winSoundPlayer.isPlaying) winSoundPlayer.seekTo(0)
+                winSoundPlayer.start()
+            }
+        }
+    }
     if (juegoTerminado) {
         AlertDialog(
             title = { Text(stringResource(R.string.congratulations)) },
Index: app/src/main/java/com/nextapp/monasterio/ui/screens/ParejasScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.nextapp.monasterio.ui.screens\r\n\r\nimport android.app.Activity\r\nimport android.content.pm.ActivityInfo\r\nimport android.util.Log\r\nimport androidx.compose.animation.Crossfade\r\nimport androidx.compose.animation.core.tween\r\nimport androidx.compose.foundation.Image\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.layout.Box\r\nimport androidx.compose.foundation.layout.Column\r\nimport androidx.compose.foundation.layout.Row\r\nimport androidx.compose.foundation.layout.Spacer\r\nimport androidx.compose.foundation.layout.aspectRatio\r\nimport androidx.compose.foundation.layout.fillMaxHeight\r\nimport androidx.compose.foundation.layout.fillMaxSize\r\nimport androidx.compose.foundation.layout.fillMaxWidth\r\nimport androidx.compose.foundation.layout.height\r\nimport androidx.compose.foundation.layout.padding\r\nimport androidx.compose.foundation.layout.size\r\nimport androidx.compose.foundation.layout.width\r\nimport androidx.compose.foundation.layout.wrapContentHeight\r\nimport androidx.compose.foundation.layout.wrapContentWidth\r\nimport androidx.compose.foundation.lazy.grid.GridCells\r\nimport androidx.compose.foundation.lazy.grid.LazyVerticalGrid\r\nimport androidx.compose.foundation.lazy.grid.items\r\nimport androidx.compose.material3.AlertDialog\r\nimport androidx.compose.material3.Button\r\nimport androidx.compose.material3.Card\r\nimport androidx.compose.material3.CardDefaults\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.IconButton\r\nimport androidx.compose.material3.MaterialTheme\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.runtime.Composable\r\nimport androidx.compose.runtime.DisposableEffect\r\nimport androidx.compose.runtime.collectAsState\r\nimport androidx.compose.runtime.getValue\r\nimport androidx.compose.runtime.mutableStateOf\r\nimport androidx.compose.runtime.remember\r\nimport androidx.compose.runtime.setValue\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.layout.ContentScale\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.painterResource\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.lifecycle.viewmodel.compose.viewModel\r\nimport androidx.navigation.NavController\r\nimport com.nextapp.monasterio.AppRoutes\r\nimport com.nextapp.monasterio.R\r\nimport com.nextapp.monasterio.models.ParejasPieza\r\nimport com.nextapp.monasterio.models.ParejasSize\r\nimport com.nextapp.monasterio.repository.UserPreferencesRepository\r\nimport com.nextapp.monasterio.viewModels.ParejasViewModel\r\nimport com.nextapp.monasterio.viewModels.ParejasViewModelFactory\r\n\r\n\r\n@Composable\r\nfun ParejasScreen(\r\n    navController: NavController,\r\n    size : ParejasSize,\r\n    imagenes : List<Int>\r\n){\r\n\r\n    val prefsRepository = remember { UserPreferencesRepository.instance }\r\n\r\n    val factory = remember { ParejasViewModelFactory(size, imagenes,prefsRepository) }\r\n    val viewModel: ParejasViewModel = viewModel(factory = factory)\r\n    val state by viewModel.uiState.collectAsState()\r\n\r\n    val context = LocalContext.current\r\n    val activity = context as? Activity\r\n\r\n    val showInstructionsPreviewDialogNullable by viewModel.showInstructionsDialog.collectAsState()\r\n    val showInstructionsPreviewDialog = showInstructionsPreviewDialogNullable ?: true\r\n\r\n    var showInstructionsPreviewDialogBoton by remember { mutableStateOf(false) }\r\n\r\n    val ruta = remember(size){\r\n        when(size.rows * size.columns){\r\n            6 -> AppRoutes.PAREJASNIVEL1\r\n            8 -> AppRoutes.PAREJASNIVEL2\r\n            10 -> AppRoutes.PAREJASNIVEL3\r\n            else -> AppRoutes.PAREJASNIVEL4\r\n        }\r\n    }\r\n\r\n    DisposableEffect(Unit) {\r\n        activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT\r\n        onDispose {\r\n\r\n        }\r\n    }\r\n\r\n   if(showInstructionsPreviewDialogNullable == null){\r\n       return\r\n   }\r\n\r\n    if(showInstructionsPreviewDialogBoton || showInstructionsPreviewDialog){\r\n        ParejaDialog(\r\n            onDismiss = {\r\n                viewModel.markInstructionsAsShown()\r\n                showInstructionsPreviewDialogBoton=false},\r\n            onConfirm = {\r\n                viewModel.markInstructionsAsShown()\r\n                showInstructionsPreviewDialogBoton=false\r\n                viewModel.iniciarJuego() },\r\n            titulo = stringResource(R.string.title_instructions),\r\n            texto = stringResource(R.string.text_instructions_pairs)\r\n        )\r\n    } else if(!showInstructionsPreviewDialog){\r\n        viewModel.iniciarJuego()\r\n    }\r\n\r\n    Column(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .background(MaterialTheme.colorScheme.surfaceVariant)\r\n            .padding(16.dp),\r\n        horizontalAlignment = Alignment.CenterHorizontally,\r\n        verticalArrangement = Arrangement.Center\r\n    ) {\r\n\r\n        Row(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .padding(bottom = 16.dp),\r\n            horizontalArrangement = Arrangement.Center,\r\n            verticalAlignment = Alignment.CenterVertically\r\n        ){\r\n            Text(\r\n                text = stringResource(R.string.left_pairs,state.parejas),\r\n                style = MaterialTheme.typography.titleMedium,\r\n                modifier = Modifier.padding(end = 32.dp)\r\n            )\r\n            IconButton(\r\n                onClick = { showInstructionsPreviewDialogBoton = true },\r\n                modifier = Modifier\r\n                    .size(32.dp)\r\n            ) {\r\n                Icon(\r\n                    painter = painterResource(R.drawable.question),\r\n                    contentDescription = stringResource(R.string.title_instructions),\r\n                    tint = Color.Black.copy(alpha = 0.7f),\r\n                )\r\n            }\r\n        }\r\n        LazyVerticalGrid(\r\n            columns = GridCells.Fixed(size.columns),\r\n            modifier = Modifier\r\n                .wrapContentHeight(Alignment.CenterVertically)\r\n                .wrapContentWidth(Alignment.CenterHorizontally)\r\n                .padding(vertical = 8.dp)\r\n                .then(\r\n                    if(size.rows == 4 ) {\r\n                        Modifier.width(270.dp)\r\n                    } else if (size.rows == 5){\r\n                        Modifier.width(220.dp)\r\n                    } else{\r\n                        Modifier.fillMaxWidth()\r\n                    }\r\n                ),\r\n            verticalArrangement = Arrangement.spacedBy(8.dp),\r\n            horizontalArrangement = Arrangement.spacedBy(8.dp),\r\n            userScrollEnabled = false\r\n        ) {\r\n            items(\r\n                state.piezas,\r\n            ){pieza ->\r\n                GridCell(pieza = pieza, mostradoInicial = state.mostradoInicial, verificandoPareja = state.verificandoPareja, onClick = { id -> viewModel.onClickPieza(id) })\r\n            }\r\n        }\r\n        Spacer(modifier=Modifier.height(16.dp))\r\n        Button(\r\n            onClick = {\r\n                viewModel.volverAMostrarParejas()\r\n            }\r\n        ) {\r\n            Text(stringResource(R.string.show_pairs))\r\n        }\r\n    }\r\n\r\n    if (state.solucionado) {\r\n        ParejaDialog(\r\n            onDismiss = {},\r\n            onConfirm = {\r\n                navController.navigate(ruta){\r\n                    popUpTo(ruta){\r\n                        inclusive = true\r\n                    }\r\n                }\r\n            },\r\n            stringResource(R.string.congratulations),\r\n            stringResource(R.string.message_game_completed)\r\n        )\r\n    }\r\n}\r\n\r\n\r\n\r\n@Composable\r\nfun ParejaDialog(\r\n    onDismiss: () -> Unit,\r\n    onConfirm : () -> Unit,\r\n    titulo:String,\r\n    texto:String\r\n){\r\n    AlertDialog(\r\n        onDismissRequest=onDismiss,\r\n        title = {\r\n            Text(titulo)\r\n        },\r\n        text = {\r\n            Text(texto)\r\n        },confirmButton = {\r\n            Button(\r\n                onClick = onConfirm\r\n            ) {\r\n                Text(stringResource(R.string.ready))\r\n            }\r\n        },\r\n    )\r\n}\r\n\r\n@Composable\r\nfun GridCell(\r\n    pieza: ParejasPieza,\r\n    mostradoInicial : Boolean,\r\n    verificandoPareja : Boolean,\r\n    onClick : (Int) -> Unit,\r\n) {\r\n    val conPareja = pieza.conPareja\r\n    val isClickable = !conPareja && !verificandoPareja\r\n    Card(\r\n        elevation = CardDefaults.cardElevation(defaultElevation = if (conPareja || pieza.estaVolteada) 4.dp else 2.dp),\r\n        modifier = Modifier\r\n            .aspectRatio(1f)\r\n            .then(\r\n                if (isClickable && !mostradoInicial){\r\n                    Modifier.clickable{ onClick(pieza.id) }\r\n                } else{\r\n                    Modifier\r\n                }\r\n            ),\r\n        shape = MaterialTheme.shapes.medium,\r\n        colors = CardDefaults.cardColors(\r\n            containerColor = Color.White\r\n        )\r\n    ) {\r\n        Box(\r\n            modifier = Modifier.fillMaxSize(),\r\n            contentAlignment = Alignment.Center\r\n        ) {\r\n            Crossfade(\r\n                targetState = if(conPareja || pieza.estaVolteada || mostradoInicial) 1 else 0,\r\n                animationSpec = tween(durationMillis = 300),\r\n                label=\"CardFlipAnimation\"\r\n            ) { state ->\r\n                if (state == 1) {\r\n                    Image(\r\n                        painter = painterResource(id = pieza.imagen),\r\n                        contentDescription = \"Pieza ${pieza.id}\",\r\n                        contentScale = ContentScale.Crop,\r\n                        modifier = Modifier.fillMaxSize()\r\n                    )\r\n                } else {\r\n                    Image(\r\n                        painterResource(R.drawable.escudo),\r\n                        contentDescription = stringResource(R.string.back_piece),\r\n                        contentScale = ContentScale.Fit,\r\n                        modifier = Modifier.fillMaxSize()\r\n                    )\r\n                }\r\n            }\r\n        }\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/nextapp/monasterio/ui/screens/ParejasScreen.kt b/app/src/main/java/com/nextapp/monasterio/ui/screens/ParejasScreen.kt
--- a/app/src/main/java/com/nextapp/monasterio/ui/screens/ParejasScreen.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ b/app/src/main/java/com/nextapp/monasterio/ui/screens/ParejasScreen.kt	(date 1765200524391)
@@ -36,6 +36,7 @@
 import androidx.compose.material3.Text
 import androidx.compose.runtime.Composable
 import androidx.compose.runtime.DisposableEffect
+import androidx.compose.runtime.LaunchedEffect
 import androidx.compose.runtime.collectAsState
 import androidx.compose.runtime.getValue
 import androidx.compose.runtime.mutableStateOf
@@ -74,6 +75,9 @@
     val state by viewModel.uiState.collectAsState()
 
     val context = LocalContext.current
+    val winSoundPlayer = remember {
+        android.media.MediaPlayer.create(context, R.raw.juego) // Aseg√∫rate de que el archivo existe
+    }
     val activity = context as? Activity
 
     val showInstructionsPreviewDialogNullable by viewModel.showInstructionsDialog.collectAsState()
@@ -93,7 +97,7 @@
     DisposableEffect(Unit) {
         activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT
         onDispose {
-
+            winSoundPlayer.release()
         }
     }
 
@@ -184,7 +188,14 @@
             Text(stringResource(R.string.show_pairs))
         }
     }
-
+    LaunchedEffect(state.solucionado) {
+        if (state.solucionado) {
+            if (winSoundPlayer != null) {
+                if (winSoundPlayer.isPlaying) winSoundPlayer.seekTo(0)
+                winSoundPlayer.start()
+            }
+        }
+    }
     if (state.solucionado) {
         ParejaDialog(
             onDismiss = {},
Index: app/src/main/java/com/nextapp/monasterio/ui/screens/HomeScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.nextapp.monasterio.ui.screens\r\n\r\nimport android.app.Activity\r\nimport android.content.pm.ActivityInfo\r\nimport android.content.res.Configuration\r\nimport androidx.compose.foundation.Image\r\nimport androidx.compose.foundation.clickable\r\nimport androidx.compose.foundation.layout.*\r\nimport androidx.compose.foundation.rememberScrollState\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.foundation.verticalScroll\r\nimport androidx.compose.material3.*\r\nimport androidx.compose.runtime.*\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.draw.clip\r\nimport androidx.compose.ui.draw.scale\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.layout.ContentScale\r\nimport androidx.compose.ui.platform.LocalConfiguration\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.res.painterResource\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.text.font.FontWeight\r\nimport androidx.compose.ui.text.style.TextAlign\r\nimport androidx.compose.ui.text.style.TextOverflow\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.unit.sp\r\nimport androidx.lifecycle.viewmodel.compose.viewModel\r\nimport androidx.navigation.NavController\r\nimport coil.compose.AsyncImage\r\nimport com.nextapp.monasterio.models.User\r\nimport com.nextapp.monasterio.AppRoutes\r\nimport com.nextapp.monasterio.R\r\nimport com.nextapp.monasterio.repository.ImagenRepository\r\nimport com.nextapp.monasterio.ui.theme.MonasteryBlue\r\nimport com.nextapp.monasterio.ui.theme.MonasteryOrange\r\nimport com.nextapp.monasterio.viewModels.AuthViewModel\r\nimport androidx.lifecycle.viewmodel.compose.viewModel\r\n\r\n@Composable\r\nfun HomeScreenContent(\r\n    navController: NavController,\r\n    topPadding: PaddingValues = PaddingValues(0.dp),\r\n    authViewModel: AuthViewModel = viewModel()\r\n) {\r\n    val context = LocalContext.current\r\n    val activity = (context as? Activity)\r\n    val repo = ImagenRepository()\r\n    var imagenFondoInicio by remember { mutableStateOf<String?>(null) }\r\n\r\n    val configuration = LocalConfiguration.current\r\n    val isLandscape = configuration.orientation == Configuration.ORIENTATION_LANDSCAPE\r\n\r\n    val userState by authViewModel.currentUser.collectAsState()\r\n    val currentUser = userState\r\n\r\n    LaunchedEffect(Unit) {\r\n        val data = repo.getImagenFondoInicio()\r\n        imagenFondoInicio = data?.url\r\n    }\r\n\r\n    DisposableEffect(Unit) {\r\n        activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED\r\n        onDispose {}\r\n    }\r\n\r\n    Box(modifier = Modifier.fillMaxSize()) {\r\n        // 1. FONDO\r\n        if (imagenFondoInicio != null) {\r\n            AsyncImage(\r\n                model = imagenFondoInicio,\r\n                contentDescription = null,\r\n                contentScale = ContentScale.Crop,\r\n                modifier = Modifier.fillMaxSize()\r\n            )\r\n        } else {\r\n            Image(\r\n                painter = painterResource(id = R.drawable.monastery_background),\r\n                contentDescription = null,\r\n                contentScale = ContentScale.Crop,\r\n                modifier = Modifier.fillMaxSize()\r\n            )\r\n        }\r\n\r\n        // 2. CONTENIDO\r\n        Box(\r\n            modifier = Modifier\r\n                .fillMaxSize()\r\n                .padding(topPadding)\r\n        ) {\r\n            if (isLandscape) {\r\n                LandscapeLayout(navController, currentUser)\r\n            } else {\r\n                PortraitLayout(navController, currentUser)\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// DISE√ëO VERTICAL (PORTRAIT)\r\n// =============================================================================\r\n@Composable\r\nfun PortraitLayout(\r\n    navController: NavController,\r\n    currentUser: User?\r\n) {\r\n    Column(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .verticalScroll(rememberScrollState())\r\n            .padding(24.dp),\r\n        horizontalAlignment = Alignment.CenterHorizontally, // Centrado general\r\n        verticalArrangement = Arrangement.Center\r\n    ) {\r\n        // Logo Superior\r\n        Image(\r\n            painter = painterResource(id = R.drawable.huelgas_inicio),\r\n            contentDescription = \"Logo\",\r\n            contentScale = ContentScale.FillWidth,\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .scale(1.1f) // Un poco m√°s grande visualmente\r\n                .padding(bottom = 48.dp)\r\n        )\r\n\r\n        val buttonModifier = Modifier\r\n            .fillMaxWidth()\r\n            .height(80.dp)\r\n\r\n        // 1. Visita\r\n        HomeListButton(\r\n            text = stringResource(R.string.virtual_visit),\r\n            iconRes = R.drawable.ic_map_24,\r\n            backgroundColor = MonasteryOrange,\r\n            modifier = buttonModifier,\r\n            onClick = { navController.navigate(AppRoutes.VIRTUAL_VISIT) }\r\n        )\r\n\r\n        Spacer(modifier = Modifier.height(24.dp))\r\n\r\n        // 2. Ni√±os\r\n        HomeListButton(\r\n            text = stringResource(R.string.child_mode),\r\n            iconRes = R.drawable.outline_account_child_invert_24,\r\n            backgroundColor = Color(0xFF6EB017),\r\n            modifier = buttonModifier,\r\n            onClick = { navController.navigate(AppRoutes.MODO_NINYOS) }\r\n        )\r\n\r\n        Spacer(modifier = Modifier.height(24.dp))\r\n\r\n        // 3. Reserva\r\n        HomeListButton(\r\n            text = stringResource(R.string.book_appointment),\r\n            iconRes = R.drawable.ic_time_24,\r\n            backgroundColor = MonasteryBlue,\r\n            modifier = buttonModifier,\r\n            onClick = { navController.navigate(AppRoutes.OPCIONES_RESERVA) }\r\n        )\r\n\r\n        // 4. Edici√≥n\r\n        if (currentUser != null) {\r\n            Spacer(modifier = Modifier.height(24.dp))\r\n            HomeListButton(\r\n                text = stringResource(R.string.edit_mode_button),\r\n                iconRes = R.drawable.lapiz,\r\n                backgroundColor = Color(0xFF9C27B0),\r\n                modifier = buttonModifier,\r\n                onClick = { navController.navigate(AppRoutes.MODO_EDICION) }\r\n            )\r\n        }\r\n        Spacer(modifier = Modifier.height(40.dp))\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// DISE√ëO HORIZONTAL (LANDSCAPE)\r\n// =============================================================================\r\n@Composable\r\nfun LandscapeLayout(\r\n    navController: NavController,\r\n    currentUser: User?\r\n) {\r\n    Row(\r\n        modifier = Modifier\r\n            .fillMaxSize()\r\n            .padding(16.dp)\r\n            .statusBarsPadding()\r\n    ) {\r\n        // IZQUIERDA: Logo (40% ancho)\r\n        Box(\r\n            modifier = Modifier\r\n                .weight(0.4f)\r\n                .fillMaxHeight(),\r\n            contentAlignment = Alignment.Center\r\n        ) {\r\n            Image(\r\n                painter = painterResource(id = R.drawable.huelgas_inicio),\r\n                contentDescription = \"Logo\",\r\n                contentScale = ContentScale.Fit,\r\n                modifier = Modifier\r\n                    .fillMaxSize()\r\n                    .scale(1.1f)\r\n            )\r\n        }\r\n\r\n        Spacer(modifier = Modifier.width(16.dp))\r\n\r\n        // DERECHA: Cuadr√≠cula (60% ancho)\r\n        Column(\r\n            modifier = Modifier\r\n                .weight(0.6f)\r\n                .fillMaxHeight(),\r\n            verticalArrangement = Arrangement.spacedBy(12.dp),\r\n            horizontalAlignment = Alignment.CenterHorizontally // Alineados a la derecha si sobra espacio\r\n        ) {\r\n            // FILA 1\r\n            Row(\r\n                modifier = Modifier.weight(1f),\r\n                horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n            ) {\r\n                HomeGridButton(\r\n                    text = stringResource(R.string.virtual_visit),\r\n                    iconRes = R.drawable.ic_map_24,\r\n                    backgroundColor = MonasteryOrange,\r\n                    modifier = Modifier.weight(1f),\r\n                    onClick = { navController.navigate(AppRoutes.VIRTUAL_VISIT) }\r\n                )\r\n                HomeGridButton(\r\n                    text = stringResource(R.string.child_mode),\r\n                    iconRes = R.drawable.outline_account_child_invert_24,\r\n                    backgroundColor = Color(0xFF6EB017),\r\n                    modifier = Modifier.weight(1f),\r\n                    onClick = { navController.navigate(AppRoutes.MODO_NINYOS) }\r\n                )\r\n            }\r\n\r\n            // FILA 2\r\n            Row(\r\n                modifier = Modifier.weight(1f),\r\n                horizontalArrangement = Arrangement.spacedBy(12.dp)\r\n            ) {\r\n                HomeGridButton(\r\n                    text = stringResource(R.string.book_appointment),\r\n                    iconRes = R.drawable.ic_time_24,\r\n                    backgroundColor = MonasteryBlue,\r\n                    modifier = Modifier.weight(1f),\r\n                    onClick = { navController.navigate(AppRoutes.OPCIONES_RESERVA) }\r\n                )\r\n\r\n                if (currentUser != null) {\r\n                    HomeGridButton(\r\n                        text = stringResource(R.string.edit_mode_button),\r\n                        iconRes = R.drawable.lapiz,\r\n                        backgroundColor = Color(0xFF9C27B0),\r\n                        modifier = Modifier.weight(1f),\r\n                        onClick = { navController.navigate(AppRoutes.MODO_EDICION) }\r\n                    )\r\n                } else {\r\n                    Spacer(modifier = Modifier.weight(1f))\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// =============================================================================\r\n// COMPONENTES\r\n// =============================================================================\r\n\r\n@Composable\r\nfun HomeListButton(\r\n    text: String,\r\n    iconRes: Int,\r\n    backgroundColor: Color,\r\n    modifier: Modifier = Modifier,\r\n    onClick: () -> Unit\r\n) {\r\n    Button(\r\n        onClick = onClick,\r\n        colors = ButtonDefaults.buttonColors(containerColor = backgroundColor),\r\n        shape = RoundedCornerShape(20.dp),\r\n        modifier = modifier,\r\n        elevation = ButtonDefaults.buttonElevation(8.dp)\r\n    ) {\r\n        Row(\r\n            modifier = Modifier.fillMaxWidth(),\r\n            verticalAlignment = Alignment.CenterVertically,\r\n            horizontalArrangement = Arrangement.Start\r\n        ) {\r\n            Icon(\r\n                painter = painterResource(id = iconRes),\r\n                contentDescription = null,\r\n                modifier = Modifier.size(48.dp)\r\n            )\r\n            Spacer(modifier = Modifier.width(16.dp))\r\n            Text(\r\n                text = text,\r\n                fontSize = 20.sp,\r\n                fontWeight = FontWeight.Bold,\r\n                textAlign = TextAlign.Center,\r\n                modifier = Modifier.weight(1f)\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n@Composable\r\nfun HomeGridButton(\r\n    text: String,\r\n    iconRes: Int,\r\n    backgroundColor: Color,\r\n    modifier: Modifier = Modifier,\r\n    onClick: () -> Unit\r\n) {\r\n    Card(\r\n        modifier = modifier\r\n            .fillMaxHeight()\r\n            .clip(RoundedCornerShape(16.dp))\r\n            .clickable { onClick() },\r\n        colors = CardDefaults.cardColors(containerColor = backgroundColor),\r\n        elevation = CardDefaults.cardElevation(8.dp)\r\n    ) {\r\n        BoxWithConstraints(\r\n            modifier = Modifier\r\n                .fillMaxSize()\r\n                .padding(8.dp),\r\n            contentAlignment = Alignment.Center\r\n        ) {\r\n            // Autoajuste de tama√±o seg√∫n espacio disponible\r\n            val availableHeight = maxHeight\r\n            val iconSize = if (availableHeight < 100.dp) 24.dp else 40.dp\r\n            val textSize = if (availableHeight < 100.dp) 14.sp else 18.sp\r\n\r\n            Column(\r\n                horizontalAlignment = Alignment.CenterHorizontally,\r\n                verticalArrangement = Arrangement.Center\r\n            ) {\r\n                Icon(\r\n                    painter = painterResource(id = iconRes),\r\n                    contentDescription = null,\r\n                    modifier = Modifier.size(iconSize),\r\n                    tint = Color.White\r\n                )\r\n                Spacer(modifier = Modifier.height(8.dp))\r\n                Text(\r\n                    text = text,\r\n                    fontSize = textSize,\r\n                    fontWeight = FontWeight.Bold,\r\n                    color = Color.White,\r\n                    textAlign = TextAlign.Center,\r\n                    lineHeight = textSize * 1.1,\r\n                )\r\n            }\r\n        }\r\n    }\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/nextapp/monasterio/ui/screens/HomeScreen.kt b/app/src/main/java/com/nextapp/monasterio/ui/screens/HomeScreen.kt
--- a/app/src/main/java/com/nextapp/monasterio/ui/screens/HomeScreen.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ b/app/src/main/java/com/nextapp/monasterio/ui/screens/HomeScreen.kt	(date 1765200687778)
@@ -37,6 +37,7 @@
 import com.nextapp.monasterio.ui.theme.MonasteryOrange
 import com.nextapp.monasterio.viewModels.AuthViewModel
 import androidx.lifecycle.viewmodel.compose.viewModel
+import android.media.MediaPlayer
 
 @Composable
 fun HomeScreenContent(
@@ -45,6 +46,10 @@
     authViewModel: AuthViewModel = viewModel()
 ) {
     val context = LocalContext.current
+    val buttonSoundPlayer = remember {
+        // Aseg√∫rate de que 'click_button' existe en res/raw, o cambia el nombre
+        MediaPlayer.create(context, R.raw.botones)
+    }
     val activity = (context as? Activity)
     val repo = ImagenRepository()
     var imagenFondoInicio by remember { mutableStateOf<String?>(null) }
@@ -55,6 +60,15 @@
     val userState by authViewModel.currentUser.collectAsState()
     val currentUser = userState
 
+    val playClickSound = {
+        if (buttonSoundPlayer != null) {
+            if (buttonSoundPlayer.isPlaying) {
+                buttonSoundPlayer.seekTo(0)
+            }
+            buttonSoundPlayer.start()
+        }
+    }
+
     LaunchedEffect(Unit) {
         val data = repo.getImagenFondoInicio()
         imagenFondoInicio = data?.url
@@ -62,7 +76,7 @@
 
     DisposableEffect(Unit) {
         activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED
-        onDispose {}
+        onDispose {buttonSoundPlayer?.release()}
     }
 
     Box(modifier = Modifier.fillMaxSize()) {
@@ -90,9 +104,9 @@
                 .padding(topPadding)
         ) {
             if (isLandscape) {
-                LandscapeLayout(navController, currentUser)
+                LandscapeLayout(navController, currentUser, playClickSound)
             } else {
-                PortraitLayout(navController, currentUser)
+                PortraitLayout(navController, currentUser, playClickSound)
             }
         }
     }
@@ -104,7 +118,8 @@
 @Composable
 fun PortraitLayout(
     navController: NavController,
-    currentUser: User?
+    currentUser: User?,
+    onPlaySound: () -> Unit
 ) {
     Column(
         modifier = Modifier
@@ -135,7 +150,8 @@
             iconRes = R.drawable.ic_map_24,
             backgroundColor = MonasteryOrange,
             modifier = buttonModifier,
-            onClick = { navController.navigate(AppRoutes.VIRTUAL_VISIT) }
+            onClick = { onPlaySound()
+                navController.navigate(AppRoutes.VIRTUAL_VISIT) }
         )
 
         Spacer(modifier = Modifier.height(24.dp))
@@ -146,7 +162,8 @@
             iconRes = R.drawable.outline_account_child_invert_24,
             backgroundColor = Color(0xFF6EB017),
             modifier = buttonModifier,
-            onClick = { navController.navigate(AppRoutes.MODO_NINYOS) }
+            onClick = { onPlaySound()
+                navController.navigate(AppRoutes.MODO_NINYOS) }
         )
 
         Spacer(modifier = Modifier.height(24.dp))
@@ -157,7 +174,8 @@
             iconRes = R.drawable.ic_time_24,
             backgroundColor = MonasteryBlue,
             modifier = buttonModifier,
-            onClick = { navController.navigate(AppRoutes.OPCIONES_RESERVA) }
+            onClick = { onPlaySound()
+                navController.navigate(AppRoutes.OPCIONES_RESERVA) }
         )
 
         // 4. Edici√≥n
@@ -168,7 +186,8 @@
                 iconRes = R.drawable.lapiz,
                 backgroundColor = Color(0xFF9C27B0),
                 modifier = buttonModifier,
-                onClick = { navController.navigate(AppRoutes.MODO_EDICION) }
+                onClick = { onPlaySound()
+                    navController.navigate(AppRoutes.MODO_EDICION) }
             )
         }
         Spacer(modifier = Modifier.height(40.dp))
@@ -181,7 +200,8 @@
 @Composable
 fun LandscapeLayout(
     navController: NavController,
-    currentUser: User?
+    currentUser: User?,
+    onPlaySound: () -> Unit
 ) {
     Row(
         modifier = Modifier
@@ -226,14 +246,16 @@
                     iconRes = R.drawable.ic_map_24,
                     backgroundColor = MonasteryOrange,
                     modifier = Modifier.weight(1f),
-                    onClick = { navController.navigate(AppRoutes.VIRTUAL_VISIT) }
+                    onClick = { onPlaySound()
+                        navController.navigate(AppRoutes.VIRTUAL_VISIT) }
                 )
                 HomeGridButton(
                     text = stringResource(R.string.child_mode),
                     iconRes = R.drawable.outline_account_child_invert_24,
                     backgroundColor = Color(0xFF6EB017),
                     modifier = Modifier.weight(1f),
-                    onClick = { navController.navigate(AppRoutes.MODO_NINYOS) }
+                    onClick = { onPlaySound()
+                        navController.navigate(AppRoutes.MODO_NINYOS) }
                 )
             }
 
@@ -247,7 +269,8 @@
                     iconRes = R.drawable.ic_time_24,
                     backgroundColor = MonasteryBlue,
                     modifier = Modifier.weight(1f),
-                    onClick = { navController.navigate(AppRoutes.OPCIONES_RESERVA) }
+                    onClick = { onPlaySound()
+                        navController.navigate(AppRoutes.OPCIONES_RESERVA) }
                 )
 
                 if (currentUser != null) {
@@ -256,7 +279,8 @@
                         iconRes = R.drawable.lapiz,
                         backgroundColor = Color(0xFF9C27B0),
                         modifier = Modifier.weight(1f),
-                        onClick = { navController.navigate(AppRoutes.MODO_EDICION) }
+                        onClick = { onPlaySound()
+                            navController.navigate(AppRoutes.MODO_EDICION) }
                     )
                 } else {
                     Spacer(modifier = Modifier.weight(1f))
Index: app/src/main/java/com/nextapp/monasterio/ui/screens/PuzzleScreen.kt
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>package com.nextapp.monasterio.ui.screens\r\n\r\nimport android.app.Activity\r\nimport android.content.pm.ActivityInfo\r\nimport android.util.Log\r\nimport androidx.compose.foundation.Image\r\nimport androidx.compose.foundation.background\r\nimport androidx.compose.foundation.border\r\nimport androidx.compose.foundation.gestures.detectDragGestures\r\nimport androidx.compose.foundation.gestures.detectTapGestures\r\nimport androidx.compose.foundation.layout.*\r\nimport androidx.compose.foundation.layout.Arrangement\r\nimport androidx.compose.foundation.lazy.LazyRow\r\nimport androidx.compose.foundation.lazy.grid.GridCells\r\nimport androidx.compose.foundation.lazy.grid.LazyVerticalGrid\r\nimport androidx.compose.foundation.lazy.grid.items\r\nimport androidx.compose.foundation.lazy.items\r\nimport androidx.compose.foundation.shape.RoundedCornerShape\r\nimport androidx.compose.material3.AlertDialog\r\nimport androidx.compose.material3.Button\r\nimport androidx.compose.material3.Divider\r\nimport androidx.compose.material3.Icon\r\nimport androidx.compose.material3.IconButton\r\nimport androidx.compose.material3.MaterialTheme.typography\r\nimport androidx.compose.material3.SegmentedButtonDefaults.Icon\r\nimport androidx.compose.material3.Text\r\nimport androidx.compose.runtime.*\r\nimport androidx.compose.ui.Alignment\r\nimport androidx.compose.ui.Modifier\r\nimport androidx.compose.ui.geometry.Offset\r\nimport androidx.compose.ui.graphics.Color\r\nimport androidx.compose.ui.input.pointer.pointerInput\r\nimport androidx.compose.ui.layout.LayoutCoordinates\r\nimport androidx.compose.ui.layout.onGloballyPositioned\r\nimport androidx.compose.ui.layout.positionInRoot\r\nimport androidx.compose.ui.layout.positionInWindow\r\nimport androidx.compose.ui.modifier.modifierLocalConsumer\r\nimport androidx.compose.ui.platform.LocalConfiguration\r\nimport androidx.compose.ui.platform.LocalContext\r\nimport androidx.compose.ui.platform.LocalDensity\r\nimport androidx.compose.ui.res.painterResource\r\nimport androidx.compose.ui.res.stringResource\r\nimport androidx.compose.ui.unit.Dp\r\nimport androidx.compose.ui.unit.IntOffset\r\nimport androidx.compose.ui.unit.dp\r\nimport androidx.compose.ui.zIndex\r\nimport androidx.lifecycle.viewmodel.compose.viewModel\r\nimport androidx.navigation.NavController\r\nimport com.nextapp.monasterio.AppRoutes\r\nimport com.nextapp.monasterio.models.GridPosicion\r\nimport com.nextapp.monasterio.models.PiezaPuzzle\r\nimport com.nextapp.monasterio.models.PuzzleSize\r\nimport com.nextapp.monasterio.viewModels.PuzzleViewModel\r\nimport com.nextapp.monasterio.viewModels.PuzzleViewModelFactory\r\nimport com.nextapp.monasterio.R\r\nimport com.nextapp.monasterio.models.PuzzleData\r\nimport com.nextapp.monasterio.models.PuzzleRotador\r\nimport com.nextapp.monasterio.repository.UserPreferencesRepository\r\n\r\n@Composable\r\nfun PuzzleScreen(\r\n    navController: NavController,\r\n    tama√±o: PuzzleSize,\r\n) {\r\n\r\n    val conjuntosDelNivel = remember(tama√±o){\r\n        when(tama√±o.rows * tama√±o.columns){\r\n            4 -> PuzzleData.PUZZLES_NIVEL1\r\n            9 -> PuzzleData.PUZZLES_NIVEL2\r\n            16 -> PuzzleData.PUZZLES_NIVEL3\r\n            else -> PuzzleData.PUZZLES_NIVEL4\r\n        }\r\n    }\r\n\r\n    val ruta = remember(tama√±o){\r\n        when(tama√±o.rows * tama√±o.columns){\r\n            4 -> AppRoutes.PUZZLENIVEL1\r\n            9 -> AppRoutes.PUZZLENIVEL2\r\n            16 -> AppRoutes.PUZZLENIVEL3\r\n            else -> AppRoutes.PUZZLENIVEL4\r\n        }\r\n    }\r\n    val tama√±oTotal = tama√±o.rows * tama√±o.columns\r\n\r\n    val puzzleSetSeleccionado = remember {\r\n        val siguienteIndice = PuzzleRotador.getSiguienteIndice(conjuntosDelNivel.size)\r\n        conjuntosDelNivel.get(siguienteIndice)\r\n    }\r\n\r\n    val listaPiezas = puzzleSetSeleccionado.piezas\r\n    val imagenCompleta = puzzleSetSeleccionado.imagenCompleta\r\n\r\n\r\n    val prefsRepository = remember { UserPreferencesRepository.instance }\r\n\r\n    val factory = remember { PuzzleViewModelFactory(tama√±o, listaPiezas,prefsRepository,imagenCompleta) }\r\n    val viewModel: PuzzleViewModel = viewModel(factory = factory)\r\n    val state by viewModel.uiState.collectAsState()\r\n    val density = LocalDensity.current\r\n\r\n    val context = LocalContext.current\r\n    val activity = context as? Activity\r\n\r\n    // Estado del Grid y la celda\r\n    var tama√±oCelda by remember { mutableStateOf(0.dp) }\r\n    var gridOriginOffset by remember { mutableStateOf(Offset.Zero) }\r\n\r\n    // Estado de Drag and Drop (flotante)\r\n    var piezaArrastradaId by remember { mutableStateOf<Int?>(null) }\r\n    var desplazamientoPiezaArrastrada by remember { mutableStateOf<Offset>(Offset.Zero) }\r\n\r\n    // Mapa de posiciones iniciales de las piezas SUELTAS en la bandeja (llenado por LazyRow)\r\n    val trayPositionsMap = remember { mutableStateMapOf<Int, Offset>() }\r\n\r\n    var showImagePreviewDialog by remember { mutableStateOf(false) }\r\n    val showInstructionsPreviewDialog by viewModel.showInstructionsDialog.collectAsState()\r\n    var showInstructionsPreviewDialogBoton by remember { mutableStateOf(false) }\r\n\r\n    var overlayRootCoordinates by remember { mutableStateOf<LayoutCoordinates?>(null) }\r\n\r\n    Log.d(\"INSTRUCCIONES_DBEBUG\",\"valor del showinstructionspreviewdialogboton: ${showInstructionsPreviewDialogBoton}\")\r\n    Log.d(\"INSTRUCCIONES_DBEBUG\",\"valor del showinstructionspreviewdialog: ${showInstructionsPreviewDialog}\")\r\n\r\n    val screenWidth = LocalConfiguration.current.screenWidthDp\r\n    val isTablet = screenWidth > 600\r\n\r\n    var dragStartRelativeOffset by remember { mutableStateOf<Offset>(Offset.Zero) }\r\n\r\n    val piezasSueltasRestantes = state.piezas.count { !it.encajada }\r\n\r\n    DisposableEffect(Unit) {\r\n        activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT\r\n        onDispose {\r\n\r\n        }\r\n    }\r\n\r\n    if(showInstructionsPreviewDialogBoton || showInstructionsPreviewDialog){\r\n        PuzzleDialog(\r\n            onDismiss = {\r\n                viewModel.markInstructionsAsShown()\r\n                showInstructionsPreviewDialogBoton = false},\r\n            onConfirm = {\r\n                viewModel.markInstructionsAsShown()\r\n                showInstructionsPreviewDialogBoton = false},\r\n            titulo = stringResource(R.string.title_instructions),\r\n            texto = stringResource(R.string.text_instructions_puzzle)\r\n        )\r\n    }\r\n    // El Box principal act√∫a como la capa de superposici√≥n (Overlay) para la pieza arrastrada.\r\n    Box(modifier = Modifier.fillMaxSize()) {\r\n        Column(\r\n            modifier = Modifier\r\n                .fillMaxSize()\r\n                .padding(16.dp)\r\n                .onGloballyPositioned { coords ->\r\n                    overlayRootCoordinates = coords\r\n                },\r\n            horizontalAlignment = Alignment.CenterHorizontally\r\n        ) {\r\n            Row(\r\n                modifier = Modifier\r\n                    .fillMaxWidth()\r\n                    .padding(bottom = 8.dp),\r\n                horizontalArrangement = Arrangement.Center,\r\n                verticalAlignment = Alignment.CenterVertically\r\n            ){\r\n                Text(\r\n                    text = stringResource(R.string.left_pieces,piezasSueltasRestantes),\r\n                    style = androidx.compose.material3.MaterialTheme.typography.titleMedium,\r\n                    modifier = Modifier.padding(end = 32.dp)\r\n                )\r\n                Spacer(modifier= Modifier.width(16.dp))\r\n                IconButton(\r\n                    onClick = { showInstructionsPreviewDialogBoton = true },\r\n                    modifier = Modifier\r\n                        .size(32.dp)\r\n                ) {\r\n                    Icon(\r\n                        painter = painterResource(R.drawable.question),\r\n                        contentDescription = stringResource(R.string.title_instructions),\r\n                        tint = Color.Black.copy(alpha = 0.7f),\r\n                    )\r\n                }\r\n            }\r\n            // --- 1. PUZZLE GRID (Drop Targets y Piezas Encajadas) ---\r\n            LazyVerticalGrid(\r\n                columns = GridCells.Fixed(tama√±o.columns),\r\n                modifier = Modifier\r\n                    .fillMaxWidth()\r\n                    .wrapContentWidth(Alignment.CenterHorizontally)\r\n                    .background(Color.LightGray.copy(0.5f))\r\n                    .border(1.dp,Color.Black)\r\n                    .onGloballyPositioned { coordinates ->\r\n                        val gridWith = coordinates.size.width\r\n                        if (gridWith > 0) {\r\n                            tama√±oCelda = with(density) { (gridWith / state.size.columns).toDp() }\r\n                            gridOriginOffset = coordinates.positionInWindow()\r\n                        }\r\n                    },\r\n                userScrollEnabled = false\r\n            ) {\r\n                items(tama√±o.rows * tama√±o.columns) { index ->\r\n                    val row = index / tama√±o.columns\r\n                    val col = index % tama√±o.columns\r\n                    val gridPosicion = GridPosicion(row, col)\r\n                    val piezaEnPosicion = state.piezas.find { it.posicionCorrecta == gridPosicion }\r\n                    GridCell(pieza = piezaEnPosicion)\r\n                }\r\n            }\r\n            Button(\r\n                onClick = { showImagePreviewDialog = true }, // Cambia el estado a true\r\n                modifier = Modifier.padding(top = 16.dp, bottom = 8.dp)\r\n            ) {\r\n                Text(text = stringResource(R.string.original_image)) // \"Mostrar Imagen Original\"\r\n            }\r\n            Text(\r\n                text = stringResource(R.string.puzzle_slide),\r\n                style = typography.titleMedium,\r\n            )\r\n\r\n            Spacer(modifier = Modifier.height(16.dp))\r\n\r\n            if (tama√±oCelda > 0.dp) {\r\n                val shuffledLoosePieces by remember(state.piezas) { // Clave: N√∫mero de piezas sueltas\r\n                    mutableStateOf(state.piezas.filter { !it.encajada }.shuffled())\r\n                }\r\n                PuzzleTray(\r\n                    piezas = shuffledLoosePieces,\r\n                    tama√±oPieza = tama√±oCelda,\r\n                    idPiezaArrastrada =  piezaArrastradaId,\r\n                    isDragInProgress = piezaArrastradaId != null,\r\n                    onPiecePositioned = { id, offset ->\r\n                        // Llenar el mapa de posiciones iniciales para el Drag & Drop\r\n                        trayPositionsMap[id] = offset\r\n                    },\r\n                    overlayRootCoordinates = overlayRootCoordinates,\r\n                    onDragStart = { p, pressPositionInsidePiece  ->\r\n                        // INICIO DEL DRAG: Activar la pieza flotante\r\n                        piezaArrastradaId = p.id\r\n                        desplazamientoPiezaArrastrada = Offset.Zero\r\n                        dragStartRelativeOffset = pressPositionInsidePiece\r\n                    }\r\n                )\r\n            }\r\n\r\n            // --- 3. DI√ÅLOGO DE SOLUCIONADO ---\r\n            if (state.solucionado) {\r\n                PuzzleDialog(\r\n                    onDismiss = {},\r\n                    onConfirm = {\r\n                        navController.navigate(ruta){\r\n                            popUpTo(ruta){\r\n                                inclusive = true\r\n                            }\r\n                        }\r\n                    },\r\n                    stringResource(R.string.congratulations),\r\n                    stringResource(R.string.message_game_completed)\r\n                )\r\n            }\r\n            if (showImagePreviewDialog) {\r\n                ImagePreviewDialog(\r\n                    imageResId = imagenCompleta,\r\n                    onDismiss = { showImagePreviewDialog = false }\r\n                )\r\n            }\r\n        }\r\n\r\n        piezaArrastradaId?.let { id ->\r\n            val piezaFlotante = state.piezas.find { it.id == id }!!\r\n            val startOffset = trayPositionsMap[id] ?: Offset.Zero\r\n\r\n            Log.d(\"PUZZLE_DRAG\", \"TrayPosition (Esquina): ${startOffset.x}, ${startOffset.y}\")\r\n\r\n            DraggableFloatingPiece(\r\n                pieza = piezaFlotante,\r\n                tama√±oCelda = tama√±oCelda,\r\n                startOffset = startOffset,\r\n                desplazamientoActual = desplazamientoPiezaArrastrada,\r\n                onDrag = { dragAmount ->\r\n                    // MOVIMIENTO: Actualizar el desplazamiento\r\n                    desplazamientoPiezaArrastrada += dragAmount\r\n                },\r\n                onDragEnd = {\r\n                    // FIN DEL DRAG: Calcular la nueva posici√≥n y llamar al ViewModel\r\n                    if (piezaArrastradaId != null) {\r\n                        val piezaSize = with(density) { tama√±oCelda.toPx() }\r\n                        val piezaActual = state.piezas.find { it.id == piezaArrastradaId }!!\r\n\r\n                        // Calcular la posici√≥n final de la pieza respecto al origen del Grid\r\n                        val finalTLX = startOffset.x + desplazamientoPiezaArrastrada.x\r\n                        val finalTLY = startOffset.y + desplazamientoPiezaArrastrada.y\r\n\r\n                        val relativeX = finalTLX - gridOriginOffset.x\r\n                        val relativeY = finalTLY - gridOriginOffset.y\r\n\r\n                        val centroRelativeX = relativeX + (piezaSize / 2f)\r\n                        val centroRelativeY = relativeY + (piezaSize / 2f)\r\n\r\n\r\n                        if((tama√±o.columns==2 || tama√±o.columns == 3) && isTablet) {\r\n                            val newColumn = (centroRelativeX / piezaSize).toInt().coerceIn(0, tama√±o.columns - 1)\r\n                            val newRow = (centroRelativeY / piezaSize).toInt().coerceIn(0, tama√±o.rows - 1)\r\n                            viewModel.soltarPieza(piezaArrastradaId!!, GridPosicion(newRow, newColumn))\r\n                        }\r\n                        else{\r\n                            val Y_Compensado = centroRelativeY + piezaSize * 1.0f\r\n\r\n                            val newColumn = (centroRelativeX / piezaSize).toInt().coerceIn(0, tama√±o.columns - 1)\r\n                            val newRow = (Y_Compensado / piezaSize).toInt().coerceIn(0, tama√±o.rows - 1)\r\n                            viewModel.soltarPieza(piezaArrastradaId!!, GridPosicion(newRow, newColumn))\r\n                        }\r\n                    }\r\n                    piezaArrastradaId = null\r\n                    desplazamientoPiezaArrastrada = Offset.Zero\r\n                }\r\n            )\r\n        }\r\n    } // Fin Box\r\n}\r\n\r\n// ... (El resto de composables en el siguiente bloque)\r\n\r\n// Este Composable dibuja una celda en el Grid (vac√≠a o con pieza encajada)\r\n@Composable\r\nfun GridCell(pieza: PiezaPuzzle?) {\r\n    val isEncajada = pieza?.encajada ?: false\r\n    Box(\r\n        modifier = Modifier\r\n            .aspectRatio(1f)\r\n            .padding(1.dp)\r\n            .border(1.dp, Color.Black)\r\n            .background(Color.LightGray.copy(alpha = 0.1f)),\r\n        contentAlignment = Alignment.Center\r\n    ) {\r\n        if (isEncajada) {\r\n            Image(\r\n                painter = painterResource(id = pieza!!.imagen),\r\n                contentDescription = \"Pieza encajada ${pieza.id}\",\r\n                modifier = Modifier.fillMaxSize()\r\n            )\r\n        }\r\n    }\r\n}\r\n\r\n// --- BANDEJA (LAZY ROW) ---\r\n@Composable\r\nfun PuzzleTray(\r\n    piezas: List<PiezaPuzzle>,\r\n    tama√±oPieza: Dp,\r\n    idPiezaArrastrada : Int?,\r\n    isDragInProgress: Boolean,\r\n    onPiecePositioned: (Int, Offset) -> Unit,\r\n    overlayRootCoordinates: LayoutCoordinates?,\r\n    onDragStart: (PiezaPuzzle, Offset) -> Unit\r\n) {\r\n    Column(\r\n        modifier = Modifier.fillMaxWidth(),\r\n        horizontalAlignment = Alignment.CenterHorizontally\r\n    ) {\r\n        LazyRow(\r\n            modifier = Modifier\r\n                .fillMaxWidth()\r\n                .height(tama√±oPieza + 16.dp), // Altura fija para el LazyRow\r\n            horizontalArrangement = Arrangement.spacedBy(8.dp),\r\n            contentPadding = PaddingValues(horizontal = 8.dp)\r\n        ) {\r\n            items(piezas, key = { it.id }) { pieza ->\r\n                // Este Box representa la pieza en la bandeja, que inicia el arrastre.\r\n                val isBeingDragged = pieza.id == idPiezaArrastrada\r\n                Box(\r\n                    modifier = Modifier\r\n                        .size(tama√±oPieza)\r\n                        .onGloballyPositioned { coords ->\r\n                            val root = overlayRootCoordinates\r\n                            if (root != null) {\r\n                                val posInOverlay = root.localPositionOf(coords, Offset.Zero)\r\n                                onPiecePositioned(pieza.id, posInOverlay)\r\n                            }\r\n                        }\r\n                        .pointerInput(isDragInProgress) {\r\n                            detectTapGestures(\r\n                                onLongPress = { offset ->\r\n                                    onDragStart(pieza, offset)\r\n                                }\r\n                            )\r\n                        }\r\n                ) {\r\n                    if(!isBeingDragged) {\r\n                        Image(\r\n                            painter = painterResource(id = pieza.imagen),\r\n                            contentDescription = \"Pieza ${pieza.id}\",\r\n                            modifier = Modifier.fillMaxSize()\r\n                        )\r\n                    }\r\n                    else{\r\n                        Spacer(modifier = Modifier.fillMaxSize())\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// --- PIEZA FLOTANTE (OVERLAY) ---\r\n// Este componente se dibuja en el Box principal y sigue el dedo.\r\n@Composable\r\nfun DraggableFloatingPiece(\r\n    pieza: PiezaPuzzle,\r\n    tama√±oCelda: Dp,\r\n    startOffset: Offset,\r\n    desplazamientoActual: Offset,\r\n    onDrag: (Offset) -> Unit,\r\n    onDragEnd: () -> Unit\r\n) {\r\n    // Calcular la posici√≥n absoluta en la pantalla (Base de la Bandeja + Movimiento del dedo)\r\n    val totalOffsetX = startOffset.x + desplazamientoActual.x\r\n    val totalOffsetY = startOffset.y + desplazamientoActual.y\r\n\r\n    Box(\r\n        modifier = Modifier\r\n            .offset {\r\n                // Aplicar el desplazamiento total\r\n                IntOffset(\r\n                    x = totalOffsetX.toInt(),\r\n                    y = totalOffsetY.toInt()\r\n                )\r\n            }\r\n            .zIndex(10f) // Asegura que est√© por encima de todo\r\n            .size(tama√±oCelda)\r\n            .pointerInput(Unit) {\r\n                // DETECCI√ìN DE MOVIMIENTO Y FIN DE ARRASTRE\r\n                detectDragGestures(\r\n                    onDragStart = {  },\r\n                    onDrag = { change, dragAmount ->\r\n                        onDrag(dragAmount)\r\n                        change.consume()\r\n                    },\r\n                    onDragEnd = onDragEnd // Llamar al fin para la l√≥gica de soltar\r\n                )\r\n            }\r\n    ) {\r\n        Image(\r\n            painter = painterResource(id = pieza.imagen),\r\n            contentDescription = \"Pieza flotante ${pieza.id}\",\r\n            modifier = Modifier.fillMaxSize()\r\n        )\r\n    }\r\n}\r\n\r\n// (Asumimos que PuzzleDialog est√° definido en tu archivo)\r\n// ...\r\n@Composable\r\nfun PuzzleDialog(\r\n    onDismiss: () -> Unit,\r\n    onConfirm : () -> Unit,\r\n    titulo: String,\r\n    texto:String\r\n){\r\n    AlertDialog(\r\n        onDismissRequest=onDismiss,\r\n        title = {\r\n            Text(titulo)\r\n        },\r\n        text = {\r\n            Text(texto)\r\n        },\r\n        confirmButton = {\r\n            Button(\r\n                onClick = onConfirm\r\n            ) {\r\n                Text(stringResource(R.string.ready))\r\n            }\r\n        },\r\n    )\r\n}\r\n\r\n@Composable\r\nfun ImagePreviewDialog(\r\n    imageResId: Int, // Recibe el ID del recurso de la imagen completa\r\n    onDismiss: () -> Unit // Funci√≥n para cerrar el di√°logo\r\n) {\r\n    AlertDialog(\r\n        onDismissRequest = onDismiss,\r\n        text = {\r\n            // Muestra la imagen completa\r\n            Image(\r\n                painter = painterResource(id = imageResId),\r\n                contentDescription = stringResource(R.string.original_image),\r\n                modifier = Modifier\r\n                    .fillMaxWidth()\r\n                    .aspectRatio(1f) // Mantener la proporci√≥n de la imagen\r\n            )\r\n        },\r\n        confirmButton = {\r\n            Button(onClick = onDismiss) {\r\n                Text(stringResource(R.string.close)) // \"Cerrar\"\r\n            }\r\n        }\r\n    )\r\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/app/src/main/java/com/nextapp/monasterio/ui/screens/PuzzleScreen.kt b/app/src/main/java/com/nextapp/monasterio/ui/screens/PuzzleScreen.kt
--- a/app/src/main/java/com/nextapp/monasterio/ui/screens/PuzzleScreen.kt	(revision 201084649e5b9617af53332a2db54aa0b291ff86)
+++ b/app/src/main/java/com/nextapp/monasterio/ui/screens/PuzzleScreen.kt	(date 1765200524454)
@@ -99,6 +99,9 @@
     val density = LocalDensity.current
 
     val context = LocalContext.current
+    val winSoundPlayer = remember {
+        android.media.MediaPlayer.create(context, R.raw.juego) // Aseg√∫rate de que el archivo existe
+    }
     val activity = context as? Activity
 
     // Estado del Grid y la celda
@@ -131,7 +134,7 @@
     DisposableEffect(Unit) {
         activity?.requestedOrientation = ActivityInfo.SCREEN_ORIENTATION_PORTRAIT
         onDispose {
-
+            winSoundPlayer.release()
         }
     }
 
@@ -243,7 +246,14 @@
                     }
                 )
             }
-
+            LaunchedEffect(state.solucionado) {
+                if (state.solucionado) {
+                    if (winSoundPlayer != null) {
+                        if (winSoundPlayer.isPlaying) winSoundPlayer.seekTo(0)
+                        winSoundPlayer.start()
+                    }
+                }
+            }
             // --- 3. DI√ÅLOGO DE SOLUCIONADO ---
             if (state.solucionado) {
                 PuzzleDialog(
